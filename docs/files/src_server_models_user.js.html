<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/server/models/user.js - Keystone Documentation</title>
    <link rel="stylesheet" href="">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/css/lucid.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
            Keystone Documentation
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>1.0.0</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/server.definitions.errorCodes", "classes/server.definitions.mailTypes", "classes/server.definitions.permissions", "classes/server.helper.AbstractSchedule", "classes/server.helper.auth", "classes/server.helper.errorResponse", "classes/server.helper.Mailer", "classes/server.helper.mongoose", "classes/server.helper.permissions", "classes/server.helper.Router", "classes/server.helper.RouterMethods", "classes/server.helper.Scheduler", "classes/server.helper.Service", "classes/server.helper.Services", "classes/server.helper.Setup", "classes/server.helper.successResponse", "classes/server.models.FailedMailSchema", "classes/server.models.SocialLinksSchema", "classes/server.models.SystemSchema", "classes/server.models.UserGroupSchema", "classes/server.models.UserProfileSchema", "classes/server.models.UserSchema", "classes/server.routes.User", "classes/server.schedules.FailedMails", "classes/server.ServerApplication", "classes/server.services.User", "classes/server.services.UserProfile", "classes/shared.definitions.languages", "classes/shared.helper.i18n"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
<div>
    <div id="sidebar">
    <div id="classes">
        <ul id="api-classes" class="nav nav-list">
                <li><a href="../classes/server.definitions.errorCodes.html">server.definitions.errorCodes</a></li>
                <li><a href="../classes/server.definitions.mailTypes.html">server.definitions.mailTypes</a></li>
                <li><a href="../classes/server.definitions.permissions.html">server.definitions.permissions</a></li>
                <li><a href="../classes/server.helper.AbstractSchedule.html">server.helper.AbstractSchedule</a></li>
                <li><a href="../classes/server.helper.auth.html">server.helper.auth</a></li>
                <li><a href="../classes/server.helper.errorResponse.html">server.helper.errorResponse</a></li>
                <li><a href="../classes/server.helper.Mailer.html">server.helper.Mailer</a></li>
                <li><a href="../classes/server.helper.mongoose.html">server.helper.mongoose</a></li>
                <li><a href="../classes/server.helper.permissions.html">server.helper.permissions</a></li>
                <li><a href="../classes/server.helper.Router.html">server.helper.Router</a></li>
                <li><a href="../classes/server.helper.RouterMethods.html">server.helper.RouterMethods</a></li>
                <li><a href="../classes/server.helper.Scheduler.html">server.helper.Scheduler</a></li>
                <li><a href="../classes/server.helper.Service.html">server.helper.Service</a></li>
                <li><a href="../classes/server.helper.Services.html">server.helper.Services</a></li>
                <li><a href="../classes/server.helper.Setup.html">server.helper.Setup</a></li>
                <li><a href="../classes/server.helper.successResponse.html">server.helper.successResponse</a></li>
                <li><a href="../classes/server.models.FailedMailSchema.html">server.models.FailedMailSchema</a></li>
                <li><a href="../classes/server.models.SocialLinksSchema.html">server.models.SocialLinksSchema</a></li>
                <li><a href="../classes/server.models.SystemSchema.html">server.models.SystemSchema</a></li>
                <li><a href="../classes/server.models.UserGroupSchema.html">server.models.UserGroupSchema</a></li>
                <li><a href="../classes/server.models.UserProfileSchema.html">server.models.UserProfileSchema</a></li>
                <li><a href="../classes/server.models.UserSchema.html">server.models.UserSchema</a></li>
                <li><a href="../classes/server.routes.User.html">server.routes.User</a></li>
                <li><a href="../classes/server.schedules.FailedMails.html">server.schedules.FailedMails</a></li>
                <li><a href="../classes/server.ServerApplication.html">server.ServerApplication</a></li>
                <li><a href="../classes/server.services.User.html">server.services.User</a></li>
                <li><a href="../classes/server.services.UserProfile.html">server.services.UserProfile</a></li>
                <li><a href="../classes/shared.definitions.languages.html">shared.definitions.languages</a></li>
                <li><a href="../classes/shared.helper.i18n.html">shared.helper.i18n</a></li>
        </ul>
    </div>
    </div>
</div>
        </div>
        <div class="span9">
    <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>

            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<div class="page-header">
    <h1>src/server/models/user.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
/**
 * user.js
 *
 * User model
 *
 *
 * @namespace server.models
 * @license GPL-3.0
 * @version 1.0
 * @author  Ercan &quot;geforcefan&quot; Aky√ºrek, https://github.com/geforcefan/
 * @updated 2017-03-10
 * @link    https://github.com/geforcefan/keystone/
 *
 *
 */

import Mongoose from &#x27;../helper/misc/mongoose&#x27;;
import bcrypt from &#x27;bcrypt&#x27;;

import UserGroupModel from &#x27;./userGroup&#x27;
import allPermissions from &#x27;../helper/user/permissions&#x27;;

import _ from &#x27;lodash&#x27;
import UserProfileSchema from &#x27;./userProfile&#x27;

/**
 * User model
 *
 * GitHub issue: https://github.com/geforcefan/keystone/issues/2
 *
 * @class UserSchema
 * @extends Mongoose.Schema
 */
export class UserSchema extends Mongoose.Schema {
    constructor() {
        super({
            /**
             * Username
             *
             * @attribute name
             * @required
             * @type String
             */
            name: {
                type: String,
                unique: true,
                required: true
            },

            /**
             * Password
             *
             * @attribute password
             * @required
             * @type String
             */
            password: {
                type: String,
                required: true
            },

            /**
             * eMail Address
             *
             * @attribute email
             * @required
             * @type String
             */
            email: {
                type: String,
                unique: true,
                required: true
            },

            /**
             * {{#crossLink &quot;server.models.UserGroupSchema&quot;}}Group{{/crossLink}} id
             *
             * @attribute groupID
             * @required
             * @type ObjectId
             */
            groupID: {
                type: String,
                required: true
            },

            /**
             * Creation date of the user
             *
             * @attribute creationDate
             * @type Date
             * @required
             * @default Date.now
             */
            creationDate: {
                type: Date,
                required: true,
                default: Date.now
            },

            /**
             * User active. After registration, user has to be activated
             *
             * @attribute active
             * @type Boolean
             * @default false
             */
            active: {
                type: Boolean,
                default: false
            },

            /**
             * Users last known remote addresses
             *
             * @attribute lastKnownRemoteAddresses
             * @type [String]
             * @default []
             */
            lastKnownRemoteAddresses: {
                type: [String],
                default: []
            },

            /**
             * User profile
             *
             * @attribute profile
             * @type server.models.UserProfileSchema
             * @default UserProfileSchema
             */
            profile: {
                type: new UserProfileSchema(),
                default: new UserProfileSchema()
            }
        });

        this.pre(&#x27;save&#x27;, this.preSave);
        this.pre(&#x27;update&#x27;, this.preSave);

        this.methods.comparePassword = this.comparePassword;
        this.methods.cacheGroupAndPermissions = this.cacheGroupAndPermissions;
        this.methods.setAuth = this.setAuth;
        this.methods.isAllowed = this.isAllowed;
        this.methods.isAuth = this.isAuth;
        this.methods.isMe = this.isMe;

        this.methods.getGroup = this.getGroup;
        this.methods.getPermissions = this.getPermissions;

        this.methods.setLocale = this.setLocale;
        this.methods.getLocale = this.getLocale;

        this.methods.addLastKnownRemoteAddress = this.addLastKnownRemoteAddress;

        this.statics.generatePasswordHash = this.generatePasswordHash;

        this.locale = UserSchema.locale;
    };

    /**
     * Generate a password hash
     * A little work around for the query hook middleware problem
     * https://github.com/saintedlama/passport-local-mongoose/issues/135
     *
     * @method generatePasswordHash
     * @static
     * @async
     * @param password {String} password
     * @param resolve {Function} resolve callback with the hash
     * @param reject {Function} reject callback
     */
    generatePasswordHash(password, resolve, reject) {
        bcrypt.genSalt(10, (err, salt) =&gt; {
            if (err)
                return reject(err);
            bcrypt.hash(password, salt, (err, hash) =&gt; {
                if (err)
                    return reject(err);

                resolve(hash);
            })
        });
    }

    /**
     * Adds a last known remote address. Always use this method,
     * since it normalizes the entries
     *
     * @method addLastKnownRemoteAddress
     * @param remoteAddress {String} remote address
     * @return {void}
     */
    addLastKnownRemoteAddress(remoteAddress) {
        this.lastKnownRemoteAddresses.unshift(remoteAddress);
        this.lastKnownRemoteAddresses = _.uniq(this.lastKnownRemoteAddresses);

        this.lastKnownRemoteAddresses =
            this.lastKnownRemoteAddresses.slice(0, UserSchema.amountOfLastKnownRemoteAddresses);
    }

    /**
     * Pre save hook which bcrypts the password before its saved to the database
     *
     * @method preSave
     * @private
     * @async
     * @param next {Function} success callback
     * @return {*}
     */
    preSave(next) {
        if (this.isModified(&#x27;password&#x27;) || this.isNew) {
            bcrypt.genSalt(10, (err, salt) =&gt; {
                if (err) {
                    return next(err);
                }
                bcrypt.hash(this.password, salt, (err, hash) =&gt; {
                    if (err) {
                        return next(err);
                    }
                    this.password = hash;
                    next();
                });
            });
        } else {
            return next();
        }
    };

    /**
     * Compare any password with the users password
     *
     * @method comparePassword
     * @async
     * @param password {String} password
     * @param next {Function} success callback
     */
    comparePassword(password, next) {
        bcrypt.compare(password, this.password, function (err, isMatch) {
            if (err) {
                return next(err);
            }
            next(null, isMatch);
        });

    };

    /**
     * A simple check whether the userID matches with the self user
     *
     * @param userID {String} user id to be compared
     * @method isMe
     * @return {Boolean}
     */
    isMe(userID) {
        return userID == this.id;
    }

    /**
     * To use {{#crossLink &quot;server.models.UserSchema/isAllowed:method&quot;}} isAllowed {{/crossLink}} method properly,
     * the user group and permissions needs to be cached
     *
     * @method cacheGroupAndPermissions
     * @async
     * @param next {Function} next callback
     * @param abort {Function} abort callback
     */
    cacheGroupAndPermissions(next, abort) {
        new Promise((resolve) =&gt; resolve())
        // get the group of the user
            .then(result =&gt; new Promise(resolve =&gt; UserGroupModel.findById(this.groupID, (err, group) =&gt; resolve(group))))
            .then(group =&gt; new Promise(resolve =&gt; {
                if (typeof this.groupID === &quot;undefined&quot; || !this.groupID)
                // fallback to guest when no groupID was provided
                    return UserGroupModel.findOne({name: &quot;guest&quot;}, (err, group) =&gt; resolve(group));
                else if (!group)
                // fallback to user when group is just not found but provided
                    return UserGroupModel.findOne({name: &quot;user&quot;}, (err, group) =&gt; resolve(group));
                // group found, just take that
                else resolve(group);
            }))
            .then(group =&gt; {
                if (!group)
                    return new Promise((resolve, reject) =&gt; reject(true));

                // assign group to the user model (makes life easy)
                this.group = group;

                // if the group has all permissions, we can grab all
                // permissions from the definitions (definitions/permissions.js)
                if (group.permissions.hasAllPermissions) {
                    this.permissions = allPermissions;

                    return new Promise((resolve, reject) =&gt; reject(false));
                } else {
                    // in this case, the group has not all the permissions and we need to grab them
                    // from the group
                    return new Promise(resolve =&gt; {
                        // find all groups with a greater level than the main group level
                        UserGroupModel.find({
                            level: {$gt: group.level}
                        }, (err, groups) =&gt; resolve([group].concat(groups)));
                    });
                }
            })
            .then(groups =&gt; {
                this.permissions = groups
                    .map(group =&gt; group.permissions.allowedTo)
                    .reduce((acc, group) =&gt; _.union(acc, group), []);

                return next();
            })
            .catch(hasError =&gt; {
                if (hasError) {
                    abort(&quot;Something is completely wrong. No group is found. &quot; +
                        &quot;Maybe there is an inconsistency in the Database, because none of the &quot; +
                        &quot;fallback groups are found (guest, user).&quot;);
                } else
                    next();
            });
    }

    /**
     * Check the user permission
     *
     * @method isAllowed
     * @param permission {String} permission to be checked
     * @return {Boolean}
     */
    isAllowed(permission) {
        return _.includes(this.permissions, permission);
    }

    /**
     * Set &quot;is user authenticated&quot;
     *
     * @method setAuth
     * @param auth {Boolean} is user authenticated
     */
    setAuth(auth) {
        this.auth = auth;
    }

    /**
     * Is user authenticated
     *
     * @method isAuth
     * @return {Boolean}
     */
    isAuth() {
        return this.auth;
    }

    /**
     * Get users group. Returns only the group when
     * {{#crossLink &quot;server.models.UserSchema/cacheGroupAndPermissions:method&quot;}}cacheGroupAndPermissions{{/crossLink}}
     * is called before
     *
     * @method getGroup
     * @returns {UserGroupSchema}
     */
    getGroup() {
        return this.group;
    }

    /**
     * Get user permissions. Returns only the permissions when
     * {{#crossLink &quot;server.models.UserSchema/cacheGroupAndPermissions:method&quot;}}cacheGroupAndPermissions{{/crossLink}}
     * is called before
     *
     * @method getPermissions
     * @returns [...]
     */
    getPermissions() {
        return this.permissions;
    }

    setLocale(locale) {
        this.locale = locale;
    }

    getLocale() {
        return this.locale;
    }
}

/**
 * Cached user permissions.
 * Will filled after calling UserSchema.cachePermissions
 *
 * @property permissions
 * @default []
 * @private
 * @type {Array}
 */
UserSchema.permissions = [];

/**
 * User authentication state. This is mostly used for the injected user model
 * in the request
 *
 * @property auth
 * @default false
 * @private
 * @type {boolean}
 */
UserSchema.auth = false;

/**
 * User group
 *
 * @property group
 * @default null
 * @private
 * @type {UserGroupSchema}
 */
UserSchema.group = null;

/**
 * Amount of last known remote addresses to be stored
 *
 * @property amountOfLastKnownRemoteAddresses
 * @default 5
 * @private
 * @type {Number}
 */
UserSchema.amountOfLastKnownRemoteAddresses = 5;


/**
 * Users current locale
 *
 * @property locale
 * @default en
 * @private
 * @type {String}
 */
UserSchema.locale = &quot;en&quot;;

export default Mongoose.model(&#x27;User&#x27;, new UserSchema());
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
